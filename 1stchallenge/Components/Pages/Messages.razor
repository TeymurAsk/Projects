@page "/messages"
@using Microsoft.AspNetCore.SignalR.Client
@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime
@inject NavigationManager navman
@implements IAsyncDisposable
<PageTitle>Inbox</PageTitle>
<br />
<div>
    <div style="float:left">
        <div>
            <input class="search-people" placeholder="Search" type="text" />
            <i class="fa-solid fa-magnifying-glass" style="position:absolute;top:54px;left:156px;color:ghostwhite"></i>
        </div>
        <br />
        @for (int i = 0; i < 5; i++)
        {
            int id = i;
            <div style="@styles_divs[id]" @onclick="(()=>{Click(id);})">
                <img style="height:52px;border-radius:50%;position:relative;top:10px;left:10px" src="https://i.imgur.com/LY5NH13.jpg" />
                <p style="@styles_text[id];position:relative;bottom:40px;left:70px;"><b>Kate Jonhson</b></p>
                <p style="@styles_text[id];position:relative;bottom:80px;left:230px">15 min</p>
                <p style="font-size:12px;@styles_text[id];position:relative;bottom:90px;left:70px;width:75%">
                    Lorem ipsum dolor sit amet, consectetur adipiscing elit.
                    Morbi malesuada vitae nulla et gravida.
                    Duis malesuada
                </p>
            </div>
            <br />
        }
    </div>
    <div style="position:absolute;top:0;left:470px;height:100%;width:1px;background-color: white;"></div>
    <div class="chat-box">
        <div style="float:right;width:300px;height:100%;display:list-item;align-items:center">
            <div style="float:left;height:100%;width:1px;background-color: white;"></div>
            <div style="display:flex;justify-content:center;margin-top:100px">
                <img style="height:100px;border-radius:50%;" src="https://i.imgur.com/LY5NH13.jpg" />
            </div>
            <div style="display:flex;justify-content:center;margin-top:30px">
                <h3 style="color:white">Teymur Asgarkhanov</h3>
            </div>
            <div style="display:flex;justify-content:center;">
                <h5 style="color:white">Status</h5>
            </div>
            <div style="display:flex;justify-content:center;color:white">
                <i class="fa-solid fa-phone" style="align-content:center;color:#CEC3F1;"></i>&nbsp; +48 00 000 00 00
            </div>
            <div style="display:flex;justify-content:center;color:white">
                <i class="fa-solid fa-envelope" style="align-content:center;color:#CEC3F1;"></i>&nbsp; example@@company.com
            </div>
        </div>
        <br />
        <div class="left-div">
            <p style="margin-left:30px;font-size:24px;color:white;">Kate Jonhson</p>
            <hr style="background-color:white;height:2px;" />
        </div>
        <div class="scrollable-area" id="scrollableArea" style="overflow-y: scroll; scroll-behavior: smooth">
            <div class="message-box">
                Hello, could you send that request of yours again? I had some troubles answering on it lately.
            </div>
            <div class="message-box-2" style="float:right;padding-left:10px;position:relative;right:10px">
                <strong>Hello. Yes, sure.</strong>
            </div>
            <br /><br />
            <div class="message-box">
                Hello, could you send that request of yours again? I had some troubles answering on it lately.
            </div>
            <div class="message-box-2" style="float:right;padding-left:10px;position:relative;right:10px">
                <strong>Hello. Yes, sure.</strong>
            </div>
            <br /><br />
            <div class="message-box">
                Hello, could you send that request of yours again? I had some troubles answering on it lately.
            </div>
            <div class="message-box-2" style="float:right;padding-left:10px;position:relative;right:10px">
                <strong>Hello. Yes, sure.</strong>
            </div>
            <br /><br />
            <div class="message-box">
                Hello, could you send that request of yours again? I had some troubles answering on it lately.
            </div>
            <div class="message-box-2" style="float:right;padding-left:10px;position:relative;right:10px">
                <strong>Hello. Yes, sure.</strong>
            </div>
            <div class="message-box">
                Hello, could you send that request of yours again? I had some troubles answering on it lately.
            </div>
            <div class="message-box-2" style="float:right;padding-left:10px;position:relative;right:10px">
                <strong>Hello. Yes, sure.</strong>
            </div>
            <br /><br />
            <div class="message-box">
                Hello, could you send that request of yours again? I had some troubles answering on it lately.
            </div>
            <div class="message-box-2" style="float:right;padding-left:10px;position:relative;right:10px">
                <strong>Hello. Yes, sure.</strong>
            </div>
            <br /><br />
            <div class="message-box">
                Hello, could you send that request of yours again? I had some troubles answering on it lately.
            </div>
            <div class="message-box-2" style="float:right;padding-left:10px;position:relative;right:10px">
                <strong>Hello. Yes, sure.</strong>
            </div>
            <br /><br />
            <div class="message-box">
                Hello, could you send that request of yours again? I had some troubles answering on it lately.
            </div>
            <div class="message-box-2" style="float:right;padding-left:10px;position:relative;right:10px">
                <strong>Hello. Yes, sure.</strong>
            </div>
            <br /><br />
            <br /><br />
            @foreach(var message in messages)
            {
                <div class="message-box-2" style="float:right;padding-left:10px;position:relative;right:10px">
                    @message
                </div>
                <br /><br />
            }
        </div>
        <textarea @bind="Message" style="padding-top:4px;font-size:20px;resize:none;position:absolute;top:610px;left:20px;border-radius:10px;width:590px;background-color:black;color:white;height:50px;border-width:6px;border-color:black"></textarea>
        <button class="send-button" @onclick="(()=>{Send(Message);})">
            <i class="fa-solid fa-paper-plane" style="padding-right: 5px;padding-top:3px;font-size:24px;color:#CEC3F1"></i>
        </button>
    </div>
</div>
@code {
    [Parameter]
    public string Message { get; set; }

    private HubConnection? hubConnection;
    private List<string> messages = new();
    Dictionary<string, string> conversation = new Dictionary<string, string>();
    private List<string> styles_divs = new List<string>()
    {
        "border-radius:20px;width:300px;height:110px;background-color:black;border:solid;border-width:2px;border-color:white",
        "border-radius:20px;width:300px;height:110px;background-color:black;border:solid;border-width:2px;border-color:white",
        "border-radius:20px;width:300px;height:110px;background-color:black;border:solid;border-width:2px;border-color:white",
        "border-radius:20px;width:300px;height:110px;background-color:black;border:solid;border-width:2px;border-color:white",
        "border-radius:20px;width:300px;height:110px;background-color:black;border:solid;border-width:2px;border-color:white",
    };
    private List<string> styles_text = new List<string>()
    {
        "color:white",
        "color:white",
        "color:white",
        "color:white",
        "color:white",
    };
    protected override async Task OnInitializedAsync()
    {
        hubConnection = new HubConnectionBuilder().WithUrl(navman.ToAbsoluteUri("/chathub")).WithAutomaticReconnect().Build();
        hubConnection.On<string>("ReceiveMessage", (message) =>
        {
            messages.Add(message);
            InvokeAsync(StateHasChanged);
        });

        await hubConnection.StartAsync();
    }
    private void Click(int id)
    {
        for(int i = 0;i<styles_divs.Count;i++)
        {
            styles_divs[i] = "border-radius:20px;width:300px;height:110px;background-color:black;border:solid;border-width:2px;border-color:white";
        }
        styles_divs[id] = "border-radius:20px;width:300px;height:110px;background-color:#CEC3F1;border:solid;border-width:2px;border-color:#CEC3F1";
        for (int i = 0; i < styles_text.Count; i++)
        {
            styles_text[i] = "color:white";
        }
        styles_text[id] = "color:black";
    }
    private async Task Send(string message)
    {
        try
        {
            if (hubConnection != null)
            {
                if (!string.IsNullOrWhiteSpace(message))
                {
                    // Check if the message contains non-whitespace characters
                    await hubConnection.SendAsync("SendMessage", message.Trim());
                }
                await JSRuntime.InvokeVoidAsync("scrollToBottom");
            }
        }
        catch (Exception ex)
        {
            // Log the error for debugging purposes
            Console.Error.WriteLine($"Error sending message: {ex.Message}");
        }
    }

    public bool IsConnected => hubConnection?.State == HubConnectionState.Connected;

    public async ValueTask DisposeAsync()
    {
        if (hubConnection != null)
        {
            await hubConnection.DisposeAsync();
        }
    }
}
